# Plan: Custom Content Collections for React Router v7

## Goal

Replace `@content-collections` with a custom Vite plugin + runtime API that works in SSR and build without filesystem access at runtime. Support Markdown + MDX inputs, precompile to HTML, and keep current routes working with minimal changes.

## Scope Decisions

- Full replacement (custom Vite plugin + virtual module).
- Support Markdown + MDX inputs now; precompile to HTML.
- Blog slugs must come from frontmatter only; fail build if missing.

## Implementation Plan

### 1) Create content pipeline utilities

- Add Markdown compiler using unified/remark/rehype to HTML.
- Add MDX compiler using `@mdx-js/mdx` and `rehype-stringify` to HTML.
- Normalize frontmatter parsing and validation using Zod schemas mirroring current ones.

### 2) Implement custom Vite plugin

- Add a Vite plugin that:
  - Scans `app/content/**/**.{md,mdx}`.
  - Parses frontmatter and validates schema per collection.
  - Compiles Markdown/MDX to HTML.
  - Builds a virtual module `virtual:content` exporting `allBlogs`, `allTexts`, `allLevelsTexts`.
  - Watches content files in dev and invalidates the virtual module.
- Ensure no filesystem access is required at runtime; all content is embedded in the virtual module.

### 3) Runtime API wrapper

- Add a small runtime module to wrap the virtual module and provide helpers (e.g., `getBlogs`, `getBlogBySlug`).
- Keep current shapes expected by routes (e.g., `blog.content` is HTML string).

### 4) Update route imports and rendering

Replace imports from `content-collections` with the new runtime API exports.

- Update routes:
  - `app/routes/blog/blog.tsx`
  - `app/routes/blog/blogPage.tsx`
  - `app/routes/levels/level.tsx`
  - `app/routes/texts/text.tsx`
- Ensure markdown rendering uses precompiled HTML; keep `ProseContent` but pass HTML and bypass `parseMarkdown`.

### 5) Wire plugin and typings

- Register the new plugin in `vite.config.ts` and remove `@content-collections/remix-vite`.
- Add `virtual:content` TypeScript declaration file.
- Remove `content-collections.ts` if no longer needed.
- Update `tsconfig.cloudflare.json` alias if it points to `.content-collections/generated`.

### 6) Clean dependencies

- Remove `@content-collections/*` packages from `package.json`.
- Add new dependencies for unified/remark/rehype + MDX pipeline as needed.

## Files to Add/Modify

- Add: `app/lib/content/vite-content-plugin.ts`
- Add: `app/lib/content/markdown.ts`
- Add: `app/lib/content/mdx.ts`
- Add: `app/lib/content/types.ts`
- Add: `app/lib/content/runtime.ts`
- Add: `app/lib/content/virtual.d.ts`
- Modify: `vite.config.ts`
- Modify: `app/components/ProseContent.tsx`
- Modify: `app/routes/blog/blog.tsx`
- Modify: `app/routes/blog/blogPage.tsx`
- Modify: `app/routes/levels/level.tsx`
- Modify: `app/routes/texts/text.tsx`
- Modify: `tsconfig.cloudflare.json` (remove alias to `.content-collections`)
- Remove: `content-collections.ts`

## Verification

- Run `npm run dev` and confirm:
  - Blog and level routes render content.
  - `?source=collection` in texts works as before.
  - HMR updates when editing content files.
- Run `npm run build` to confirm SSR build completes.
